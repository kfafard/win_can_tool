name: Release Pipeline

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    id-token: write

jobs:
    build-pypi:
        name: Build & Publish to PyPI
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install stable build toolchain (avoids Metadata-Version 2.3)
              run: |
                  pip install --upgrade pip
                  pip install "setuptools<72" "build<1.2" wheel

            - name: Inject version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
                  echo "__version__ = \"$VERSION\"" > win_can_tool/version.py

            - name: Build wheel and sdist
              run: python -m build

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  password: ${{ secrets.PYPI_API_TOKEN }}

    build-exe:
        name: Build Windows EXE
        needs: build-pypi
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  pip install pyinstaller
                  pip install .

            - name: Build EXE
              run: |
                  pyinstaller --onefile --windowed --name win_can_tool --icon win_can_tool.ico can_gui_launcher.py

            - name: Upload EXE artifact
              uses: actions/upload-artifact@v4
              with:
                  name: win_can_tool-exe
                  path: dist/win_can_tool.exe

    changelog:
        name: Generate Changelog
        needs: build-pypi
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Use git-cliff action
              uses: orhun/git-cliff-action@v3
              with:
                  config: cliff.toml
                  args: -o CHANGELOG.md

            - name: Commit updated changelog
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "docs: update changelog for ${{ github.ref_name }}"
                  file_pattern: CHANGELOG.md

    release:
        name: GitHub Release
        needs: [build-exe, changelog]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Download EXE artifact
              uses: actions/download-artifact@v4
              with:
                  name: win_can_tool-exe
                  path: ./dist

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/win_can_tool.exe
                      dist/*.whl
                      dist/*.tar.gz
