name: Release Pipeline

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write

jobs:
  build-pypi:
    name: Build & Publish to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install stable build toolchain
        run: |
          pip install --upgrade pip
          pip install "setuptools<72" "build<1.2" wheel

      - name: Inject version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          echo "__version__ = \"$VERSION\"" > win_can_tool/version.py

      - name: Build wheel + sdist
        run: python -m build

      - name: Upload Python package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pypi-dist
          path: dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  build-exe:
    name: Build Windows EXE
    needs: build-pypi
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install pyinstaller
          pip install .

      - name: Build EXE
        run: |
          pyinstaller --onefile --windowed --name win_can_tool --icon win_can_tool.ico can_gui_launcher.py

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: win_can_tool-exe
          path: dist/win_can_tool.exe

  changelog:
    name: Generate Changelog
    needs: build-pypi
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # üê≥ Use official Docker image ‚Äî no more broken installs
      - name: Generate changelog
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            -w /work \
            orhunp/git-cliff:latest \
            -c cliff.toml -o CHANGELOG.md

      # üî• Fix: git-auto-commit cannot run on a tag checkout
      # Move to main and merge the release commit
      - name: Switch to main branch
        run: |
          git fetch origin main
          git checkout main
          git merge --no-edit $GITHUB_SHA

      - name: Commit CHANGELOG.md
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update changelog for ${{ github.ref_name }}"
          file_pattern: CHANGELOG.md

      - name: Upload CHANGELOG
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  release:
    name: GitHub Release
    needs: [build-exe, changelog]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download EXE
        uses: actions/download-artifact@v4
        with:
          name: win_can_tool-exe
          path: ./dist

      - name: Download Python package artifacts
        uses: actions/download-artifact@v4
        with:
          name: pypi-dist
          path: ./dist

      - name: Download CHANGELOG
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: ./

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/win_can_tool.exe
            dist/*.whl
            dist/*.tar.gz
            CHANGELOG.md
